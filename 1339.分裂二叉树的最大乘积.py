#
# @lc app=leetcode.cn id=1339 lang=python3
#
# [1339] 分裂二叉树的最大乘积
#
from sbw import *
# @lc code=start
# Definition for a binary tree node.
# class TreeNode:
#     def __init__(self, val=0, left=None, right=None):
#         self.val = val
#         self.left = left
#         self.right = right
class Solution:
    def maxProduct(self, root: Optional[TreeNode]) -> int:
        cache=set()
        def sum_node(node:TreeNode):
            if not node:
                return 0
            left=sum_node(node.left)
            right=sum_node(node.right)
            cache.add(left)
            cache.add(right)
            return node.val+left+right
        tot=sum_node(root)
        avg1=avg2=tot//2
        if tot&1:
            avg2+=1
        # nums=sorted(cache)
        # l,r=0,len(nums)
        # while l<r:
        Mod=10**9+7
        left,right=1,float('inf')
        for n in cache:
            if n==avg1 or n==avg2:
                return (avg1*avg2)%Mod
            elif n<avg1:
                left=max(left,n)
            elif n>avg2:
                right=min(right,n)
        return max(left*(tot-left),right*(tot-right))%Mod

# @lc code=end
assert Solution().maxProduct(TreeNode.build('[4140,7470,7663,6471,6596,1840,1557,7340,2002,2414,6359,8608,5833,3772,303,4649,4728,7527,6335,4512,5479,2189,1231,1841,3580,9917,null,6165,6363,8152,8205,9514,3346,7660,2480,null,7832,3193,4808,4352,7527,1671,null,6562,138,7313,9962,6396,9007,7851,8080,null,null,5379,9674,1567,null,9751,7040,null,null,null,null,null,null,2453,1114,null,1581,null,8489,null,6368,4285,6084,507,1507,5010,4417,396,9133,1899,3415,7542,2679,1162,6442,1520,5912,1196,5245,null,null,8186,7751,9003,null,6423,8484,4018,8187,1520,2271,null,null,null,5083,4407,6019,5896,1685,null,515,null,null,282,4603,null,9939,null,9176,458,1154,4936,2493,7184,7099,9609,6087,1675,275,4791,null,689,5712,1012,1334,null,null,976,null,5405,8213,1505,5525,255,5420,9251,4604,null,null,3490,5836,7889,9251,null,4644,null,null,6477,889,6114,3241,6172,null,null,1455,1023,1832,4762,9716,3348,5836,null,9704,5038,5789,null,5594,1387,2103,null,null,1891,1216,1248,7016,null,null,1633,1139,null,null,8103,2061,1959,null,1949,null,null,8472,4864,3027,6767,5461,2051,3580,2623,8068,null,null,null,8852,5952,7892,null,3894,3126,null,null,null,1916,8460,5596,5150,417,4799,2283,310,2005,465,3259,2897,8228,2266,9754,9061,8523,null,4927,null,7212,1032,null,null,null,null,null,null,2862,6015,9781,null,236,1558,9635,4287,8720,null,2704,null,null,4462,5418,null,9606,8338,null,5132,4244,2278,9565,7747,null,null,null,null,4885,null,null,null,1890,null,5731,null,5531,7317,6313,null,4163,null,null,null,null,null,9576,null,8068,8188,null,5606,4766,2474,7513,4520,2575,3667,4081,760,6293,4700,8087,2776,2088,8987,5352,5495,7235,6334,null,2816,3564,8581,null,null,3176,779,null,null,8849,null,4259,null,null,null,null,null,null,8898,null,4062,null,null,null,null,null,7209,1413,7528,6838,5344,3111,9921,3149,5138,3242,null,9913,4171,1955,8718,696,7203,6608,9770,null,867,null,null,7842,null,4835,550,9151,2083,null,3295,null,null,3494,null,null,null,134,4161,null,5865,3707,6859,null,null,null,null,null,null,3667,null,6808,null,null,null,4072,8093,null,8384,null,null,449,15,null,5428,null,null,null,null,null,null,null,null,8526,7127,null,null,79,null,7920,5213,2696,5798,null,null,null,null,7824,null,2272,277,null,8024,8451,2597,9475,2669,2655,4059,2002,6201,4148,2288,3784,6583,7105,841,1389,4833,4395,5682,null,9469,9118,1554,null,2506,1011,null,null,7599,null,null,5758,414,null,null,5849,null,null,null,3086,4409,null,6833,3264,7494,null,1401,5622,3649,3702,8401,5997,194,null,4305,4461,null,null,null,5110,7650,null,2070,null,3766,null,5197,1638,9312,55,null,8748,5951,null,null,5726,2233,7052,9477,3267,2898,null,5830,8500,7162,761,3544,null,null,null,null,6861,null,null,null,3623,8529,null,null,4149,null,8754,8115,5596,7631,4923,null,null,null,null,1680,null,1779,9995,3459,null,486,4310,2353,null,8736,358,null,null,6426,null,null,null,7250,null,null,5438,3327,5258,null,9189,6547,8978,3466,7460,6706,4729,849,1004,null,null,8543,5159,null,875,null,null,8535,null,1530,3956,null,null,4743,3323,6108,1545,6232,3099,null,null,9553,8185,7756,2716,5324,8540,8354,null,9062,5615,9988,7950,1979,1184,1970,8508,60,9926,8142,null,2107,4859,7710,null,null,2481,null,null,null,1010,2628,null,null,null,9598,null,null,null,null,null,null,null,6216,3122,null,null,null,2048,6856,6240,4248,3184,null,7691,2237,7119,null,7706,7903,339,6956,null,null,null,5244,1000,null,null,null,2049,3,null,null,null,7190,9611,6114,null,null,3777,6676,1957,6456,null,null,null,null,null,2313,null,null,7484,null,7847,null,null,null,9648,null,null,null,3490,null,null,null,8227,null,2464,7476,5173,6873,null,1776,null,7819,null,null,null,null,null,null,null,8669,1049,4315,2802,3960,null,8038,null,null,null,null,2641,null,null,null,null,null,null,null,null,null,null,null,null,1473,null,9895,null,3665,4793,null,null,null,6866,9125,null,3636,7012,4671,null,2681,5856,265,2107,null,2701,4054,7411,9363,null,null,6432,null,7992,5125,9256,null,null,832,1187,3703,null,1243,8451,7697,8634,3944,296,1778,null,null,7878,121,5047,249,3167,1938,3060,7871,null,1440,8341,null,null,7842,6126,null,7346,null,227,3728,null,3526,null,null,8453,8262,5724,4811,null,1885,5271,5695,5342,5926,5640,2672,null,null,4356,4688,null,5825,null,null,null,null,177,null,5182,5974,null,null,null,6008,415,7924,7987,null,4313,1625,3563,8042,2936,null,null,null,8960,null,null,null,3497,6984,null,null,3218,null,null,null,7467,3201,3108,9259,null,1755,null,null,null,null,null,null,3546,null,4114,9575,2464,668,null,3049,154,9928,null,null,7777,6589,null,835,null,null,null,null,null,null,null,null,null,null,null,3257,null,null,null,null,4303,4721,null,null,null,null,null,356,6072,null,null,4777,null,null,null,null,null,2750,294,1219,null,null,3436,null,7996,1869,3283,5734,7961,6221,9798,4701,null,5726,null,null,4583,4144,4578,null,1778,915,null,null,4170,3613,null,8472,7295,6177,7041,null,1377,null,null,null,null,null,3324,7072,2129,8018,7880,null,null,null,5301,null,526,1519,null,7761,null,null,null,1335,null,9990,null,null,null,2583,null,2722,null,null,3955,4238,7262,null,5439,883,4924,2239,7468,1717,null,null,9115,412,null,3654,null,2524,null,null,6957,null,8300,9374,2317,7842,2100,8238,2462,6247,null,1767,6548,7589,4624,6587,null,1078,5248,5404,9910,9296,7928,99,null,1657,3349,9073,121,219,null,null,null,2325,null,null,null,null,null,null,null,null,null,null,6891,1262,null,2522,null,7897,9063,3686,2374,2618,null,null,7665,555,891,null,null,4667,null,null,null,null,966,null,2189,1293,null,6891,null,3630,4428,null,6725,null,9807,894,6440,null,8212,null,null,null,null,null,2234,2472,null,2393,null,null,3785,null,null,311,3975,null,null,null,4967,null,null,7630,null,null,4841,2982,null,null,null,4453,null,6497,5583,6488,653,6236,7706,null,null,null,8713,null,null,null,8444,2133,2767,null,null,8606,2996,283,null,null,7084,6281,null,null,6753,null,6159,8035,null,null,null,5300,null,null,null,null,null,null,null,null,6945,null,null,null,null,1432,349,2242,6505,8339,null,null,9076,null,null,null,6860,null,null,null,2616,null,null,3351,null,5020,null,null,null,7599,3507,2857,null,null,null,9476,1645,6184,9869,5478,640,1794,1066,null,null,null,2259,null,null,null,null,null,null,null,null,3544,null,9935,7794,6214,null,5886,2936,631,8855,null,null,null,null,null,null,3331,null,null,705,null,null,1322,null,243,null,6939,null,7280,8973,null,3648,null,8036,6012,1616,null,8683,5230,null,7862,null,null,null,9051,4594,3712,7130,null,null,null,null,7775,null,4294,null,1901,3467,null,null,7150,null,7730,6448,494,2528,4204,990,3437,4505,null,null,null,null,8094,null,null,7535,9254,9284,null,null,null,null,null,null,null,null,null,2196,null,2036,454,null,263,6539,null,1770,null,null,null,null,null,null,null,7250,5782,null,null,null,null,null,null,2564,4485,null,9491,null,960,1757,1658,null,null,null,null,null,null,null,3366,1102,null,null,null,8823,5722,null,5786,null,null,null,null,null,625,null,3318,4960,5104,null,4318,null,null,8804,8099,9187,8244,null,null,1798,null,null,15,129,null,4334,5091,3744,null,8720,null,4869,5321,null,null,null,null,null,null,null,null,null,null,null,null,8286,7087,null,null,null,1985,3030,2310,null,null,null,null,null,null,null,8060,null,null,null,null,5767,8118,7985,null,null,5657,4930,8120,null,null,3388,null,9727,6997,8015,null,1990,null,null,null,null,null,8264,6670,null,null,null,799,null,null,6579,null,1520,null,null,null,null,3411,null,null,8488,6066,null,null,null,8238,null,6673,null,7588,null,null,null,null,6453,null,560,8682,null,null,null,6920,null,null,null,null,null,null,null,null,3620,null,2846,7468,6782,null,1024,7097,null,null,null,null,3359,null,null,null,null,7839,null,null,1508,3473,null,null,null,null,7554,5877,null,null,null,4432,null,8258,5455,231,null,4729,null,null,null,null,null,6849,null,4323,null,null,null,null,null,null,125,null,null,null,8959,null,2240,null,null,2446,null,null,6678,null,null,null,null,3639,null,null,null,null,null,null,null,1254,1738,4101,419,500,null,null,7796,470,null,null,null,null,null,2932,null,null,null,4767,null,9445,null,null,null,null,null,null,3553,null,9612,null,3227,null,null,null,3641,4975,null,null,4482,3829,5997,7044,null,null,null,null,8317,9332,1230,7194,null,306,4030,8395,null,null,null,null,null,null,5866,8109,2980,null,null,null,null,null,null,208,null,2152,null,null,null,null,9744,833,6893,null,null,376,3350,926,null,null,null,null,null,null,7813,null,619,780,null,6022,null,null,null,null,null,null,4741,2743,736,null,null,null,null,null,null,null,null,4304,null,null,null,7423,4820,null,2715,3951,null,null,null,null,null,null,null,652,548,7463,null,null,null,8709,null,null,null,null,null,null,null,8211,null,null,6684,null,null,null,null,null,null,4385,7336,1521,null,null,null,5315,null,4512,null,null,null,1162,null,null,null,1212,9547,null,801,7850,null,null,null,2937,null,9204,null,5489,null,9931,9765,null,null,null,505,9005,3546,null,null,null,null,6694,3178,4160,8157,4704,null,null,null,null,null,null,null,7009,1110,5345,8527,null,null,6082,null,284,4373,null,3338,2636,5136,7740,6935,null,null,3277,null,1908,null,null,null,null,null,null,null,null,7467,null,9506,698,4628,null,180,1723,6112,825,null,null,null,null,null,null,5938,null,3584,null,null,null,2744,1589,2513,5165,null,null,null,null,2579,null,5028,null,null,null,null,null,2093,null,null,null,null,null,null,null,null,8636,3685,null,null,null,null,3493,null,null,null,null,null,null,null,null,null,3347,6851,638,6111,null,null,406,null,null,null,null,null,null,null,null,null,null,null,null,3519,null,null,null,null,null,null,null,null,null,2505,null,null,673,null,2361,6846,null,1275,9625,null,5804,null,7527,4613,null,null,null,7427,null,null,null,null,null,null,8221,8200,null,null,null,295,6030,null,null,null,null,null,null,null,null,1049,null,9402,null,3741,5418,8570,null,null,null,null,null,null,null,null,null,null,9600,null,null,null,null,null,3775,null,null,1273,null,null,null,null,null,null,null,5252,null,7345,6368]'))==345081841
assert Solution().maxProduct(TreeNode.build([1,1]))==1
assert Solution().maxProduct(TreeNode.build([2,3,9,10,7,8,6,5,4,11,1]))==1025
assert Solution().maxProduct(TreeNode.build('[1,null,2,3,4,null,null,5,6]'))==90
assert Solution().maxProduct(TreeNode.build([1,2,3,4,5,6]))==110
